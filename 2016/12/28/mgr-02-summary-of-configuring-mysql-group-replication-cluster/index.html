
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>【 MGR 】02 - Summary of configuring MGR cluster | ruiayLin&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="ruichao.lin">
    

    
    <meta name="description" content="Introduction This is second post in the series. In this post, i will share something tricky.   相关历史链接: Mgr 01 - Build a MGR cluster in ten minutesMac Pro上面使用Xcode调试MySQL代码 本文讲述MGR两个比较诡异的地方:  加载 MGR pl">
<meta property="og:type" content="article">
<meta property="og:title" content="【 MGR 】02 - Summary of configuring MGR cluster">
<meta property="og:url" content="http://ruiaylin.github.io/2016/12/28/mgr-02-summary-of-configuring-mysql-group-replication-cluster/index.html">
<meta property="og:site_name" content="ruiayLin&#39;s Blog">
<meta property="og:description" content="Introduction This is second post in the series. In this post, i will share something tricky.   相关历史链接: Mgr 01 - Build a MGR cluster in ten minutesMac Pro上面使用Xcode调试MySQL代码 本文讲述MGR两个比较诡异的地方:  加载 MGR pl">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-12-28T09:20:00.000Z">
<meta property="article:modified_time" content="2024-03-03T01:58:31.661Z">
<meta property="article:author" content="ruichao.lin">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="Group Replicaiton">
<meta property="article:tag" content="MGR">
<meta property="article:tag" content="Replicaiton">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="ruiayLin&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.1.1"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.jpeg" alt="ruiayLin&#39;s Blog" title="ruiayLin&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="ruiayLin&#39;s Blog">ruiayLin&#39;s Blog</a></h1>
				<h2 class="blog-motto">蹈之而弗悔 , 慎思而笃行 ...</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:ruiaylin.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/28/mgr-02-summary-of-configuring-mysql-group-replication-cluster/" title="【 MGR 】02 - Summary of configuring MGR cluster" itemprop="url">【 MGR 】02 - Summary of configuring MGR cluster</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ruichao.lin" target="_blank" itemprop="author">ruichao.lin</a>
		
  <p class="article-time">
    <time datetime="2016-12-28T09:20:00.000Z" itemprop="datePublished"> 发表于 2016-12-28</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98-%E5%BC%BA%E5%88%B6%E4%BD%BF%E7%94%A8root%E5%88%9B%E5%BB%BAmgr%E7%9B%B8%E5%85%B3%E8%B4%A6%E6%88%B7"><span class="toc-number">2.</span> <span class="toc-text">第一个问题: 强制使用root创建mgr相关账户</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E6%8F%8F%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">详细描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">代码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86"><span class="toc-number">2.3.</span> <span class="toc-text">问题处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E4%B8%AA%E9%97%AE%E9%A2%98-MGR%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98host%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="toc-number">3.</span> <span class="toc-text">第二个问题: MGR集群成员host的默认值</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90-1"><span class="toc-number">3.2.</span> <span class="toc-text">代码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86-1"><span class="toc-number">3.3.</span> <span class="toc-text">问题处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">解决办法 1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95-2"><span class="toc-number">3.3.2.</span> <span class="toc-text">解决办法 2</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary"><span class="toc-number">4.</span> <span class="toc-text">Summary</span></a></li></ol>
		
		</div>
		
		<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><blockquote>
<p>This is second post in the series. In this post, i will share something tricky. </p>
</blockquote>
<p><strong>相关历史链接:</strong></p>
<p><a href="/2016/12/22/mgr-01-build-a-mysql-group-replication-cluster-in-10-minutes/">Mgr 01 - Build a MGR cluster in ten minutes</a><br><a href="/2015/06/03/mysql%20source%20code%20debug%20xcode/">Mac Pro上面使用Xcode调试MySQL代码</a></p>
<p><em>本文讲述MGR两个比较诡异的地方:</em></p>
<ul>
<li><code>加载 MGR plugin的时候,用写死root用户来进行plugin associated user account 的创建</code> </li>
<li><code>配置组成员的时候, 默认member_host会采用系统的 hostname,导致无法加入新成员</code></li>
</ul>
<h2 id="第一个问题-强制使用root创建mgr相关账户"><a href="#第一个问题-强制使用root创建mgr相关账户" class="headerlink" title="第一个问题: 强制使用root创建mgr相关账户"></a>第一个问题: 强制使用root创建mgr相关账户</h2><h3 id="详细描述"><a href="#详细描述" class="headerlink" title="详细描述"></a>详细描述</h3><p>当系统中没有root账户的时候, 无法安装 MGR plugin, 报错. 经过分析代码, 发现是加载 MGR plugin 的时候,<br>需要创建 _gr_user 账户, 创建账户的代码写死了,必须使用 root . </p>
<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p>代码文件路径: </p>
<pre><code>rapid/plugin/group_replication/src/sql_service/sql_service_gr_user.cc
</code></pre>
<p>具体代码: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">int create_group_replication_user(bool threaded,</span><br><span class="line">                                  Sql_service_interface *sql_interface)</span><br><span class="line">&#123;</span><br><span class="line">  DBUG_ENTER(&quot;create_group_replication_user&quot;);</span><br><span class="line">  int error = 0;</span><br><span class="line">  Sql_service_interface *server_interface= NULL;</span><br><span class="line">  if (sql_interface == NULL) &#123;</span><br><span class="line">    server_interface= new Sql_service_interface();</span><br><span class="line">    if (!threaded)</span><br><span class="line">      error = server_interface-&gt;open_session();</span><br><span class="line">    else</span><br><span class="line">      error = server_interface-&gt;open_thread_session(get_plugin_pointer());</span><br><span class="line"></span><br><span class="line">    if (error) &#123;</span><br><span class="line">      /* purecov: begin inspected */</span><br><span class="line">      log_message(MY_ERROR_LEVEL,</span><br><span class="line">                  &quot;Can&#x27;t establish a internal server connection to execute&quot;</span><br><span class="line">                  &quot; plugin operations&quot;);</span><br><span class="line">      delete server_interface;</span><br><span class="line">      DBUG_RETURN(error);</span><br><span class="line">      /* purecov: end */</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    server_interface= sql_interface;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  error= server_interface-&gt;set_session_user(&quot;root&quot;);</span><br><span class="line">    </span><br><span class="line">  if (error)</span><br><span class="line">  &#123;</span><br><span class="line">    /* purecov: begin inspected */</span><br><span class="line">    log_message(MY_ERROR_LEVEL,</span><br><span class="line">                &quot;Can&#x27;t use the root account to create the plugin associated user&quot;</span><br><span class="line">                &quot; account to access the server.&quot;);</span><br><span class="line">    if (sql_interface == NULL)</span><br><span class="line">      delete server_interface;</span><br><span class="line">    DBUG_RETURN(error);</span><br><span class="line">    /* purecov: end */</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  long srv_err= 0;</span><br><span class="line">  std::string query;</span><br><span class="line">  query.assign(&quot;SET @GR_OLD_LOG_BIN=@@SQL_LOG_BIN;&quot;);</span><br><span class="line">  if ((srv_err= execute_user_query(server_interface,query)))</span><br><span class="line">    goto err; /* purecov: inspected */</span><br><span class="line"></span><br><span class="line">  query.assign(&quot;SET SESSION SQL_LOG_BIN=0;&quot;);</span><br><span class="line">  if ((srv_err= execute_user_query(server_interface,query)))</span><br><span class="line">    goto err; /* purecov: inspected */</span><br><span class="line"></span><br><span class="line">  query.assign(&quot;CREATE USER IF NOT EXISTS &quot; GROUPREPL_ACCOUNT &quot; IDENTIFIED&quot;</span><br><span class="line">               &quot; WITH mysql_native_password AS&quot;</span><br><span class="line">               &quot; &#x27;*7CF5CA9067EC647187EB99FCC27548FBE4839AE3&#x27; ACCOUNT LOCK;&quot;);</span><br><span class="line">  if ((srv_err= execute_user_query(server_interface,query)))</span><br><span class="line">    goto err; /* purecov: inspected */</span><br><span class="line"></span><br><span class="line">  query.assign(&quot;GRANT SELECT ON performance_schema.replication_connection_status&quot;</span><br><span class="line">               &quot; TO &quot; GROUPREPL_ACCOUNT);</span><br><span class="line">  if ((srv_err= execute_user_query(server_interface,query)))</span><br><span class="line">    goto err; /* purecov: inspected */</span><br><span class="line"></span><br><span class="line">  query.assign(&quot;GRANT SUPER ON *.* TO &quot; GROUPREPL_ACCOUNT);</span><br><span class="line">  if ((srv_err= execute_user_query(server_interface,query)))</span><br><span class="line">    goto err; /* purecov: inspected */</span><br><span class="line"></span><br><span class="line">  query.assign(&quot;FLUSH PRIVILEGES;&quot;);</span><br><span class="line">  if ((srv_err= execute_user_query(server_interface,query)))</span><br><span class="line">    goto err; /* purecov: inspected */</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">  query.assign(&quot;SET SESSION SQL_LOG_BIN=@GR_OLD_LOG_BIN;&quot;);</span><br><span class="line">  srv_err+= execute_user_query(server_interface,query);</span><br><span class="line"></span><br><span class="line">  if (sql_interface == NULL)</span><br><span class="line">  &#123;</span><br><span class="line">    delete server_interface;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DBUG_RETURN(srv_err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 第29行 将root用户写死在里面了, 本来安装我上一篇文章进行部署是不会有问题的, 我们组小伙伴部署的时候,将root账户删除了, 提示无法加载plugin, 报如下错误. </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2016-12-26T13:20:54.037658+08:00 8 [ERROR] Plugin group_replication reported: &#x27;Can&#x27;t use the root account to create the plugin associated user account to access the server.&#x27;</span><br><span class="line">2016-12-26T13:20:54.037666+08:00 8 [ERROR] Plugin group_replication reported: &#x27;Could not evaluate if the group replication user is present in the server&#x27;</span><br><span class="line">2016-12-26T13:20:54.037692+08:00 8 [Note] Plugin group_replication reported: &#x27;Requesting to leave the group despite of not being a member&#x27;</span><br><span class="line">2016-12-26T13:20:54.037699+08:00 8 [ERROR] Plugin group_replication reported: &#x27;Error calling group communication interfaces while trying to leave the group&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="问题处理"><a href="#问题处理" class="headerlink" title="问题处理"></a>问题处理</h3><p>既然找到原因, 把root账户恢复, 就可以正常加载了. </p>
<p><code>这个问题,已经向官方提交了bug</code><br>链接如下: <a target="_blank" rel="noopener" href="http://bugs.mysql.com/bug.php?id=84337">http://bugs.mysql.com/bug.php?id=84337</a><br>不过后来发现 八月份的时候就有一个在lab版本的bug <a target="_blank" rel="noopener" href="http://bugs.mysql.com/bug.php?id=82687">http://bugs.mysql.com/bug.php?id=82687</a> , 而发布正式版的时候没有修正. </p>
<p>建议: 不写死root账户 </p>
<ul>
<li>可以设置参数控制, 可以动态修改值, 默认值为 root</li>
<li>创建用户的时候,获取有创建新账户的用户,然后创建MGR 相关内部账户</li>
</ul>
<h2 id="第二个问题-MGR集群成员host的默认值"><a href="#第二个问题-MGR集群成员host的默认值" class="headerlink" title="第二个问题: MGR集群成员host的默认值"></a>第二个问题: MGR集群成员host的默认值</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>容器hostname:</p>
<pre><code>[root@b9cc57bc41f3 /]# hostname
b9cc57bc41f3
[root@b9cc57bc41f3 /]# hostname -i
172.17.0.2
</code></pre>
<p>配置完成第一个节点:<br>查看组member如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@(none) 02:14:47&gt;select * from performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+--------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST  | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+--------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 1894ecbf-cd6a-11e6-b76f-0242ac110002 | b9cc57bc41f3 |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+--------------+-------------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>MEMBER_HOST 一列显示是 容器的 hostname, 这样一看貌似没有问题, 但是会导致加入新节点成功,但是做全局恢复的时候失败.(节点加入逻辑后续会详细讲解).<br>下面我们加入第二个节点:<br>加入第二个节点之后: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@(none) 02:18:20&gt;root@(none) 02:18:20&gt;select * from performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+--------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST  | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+--------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 1894ecbf-cd6a-11e6-b76f-0242ac110002 | b9cc57bc41f3 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 1eff4c26-cd6a-11e6-b90d-0242ac110003 | 906ac9ba2dd9 |        3306 | RECOVERING   |</span><br><span class="line">+---------------------------+--------------------------------------+--------------+-------------+--------------+</span><br></pre></td></tr></table></figure>

<p>在新加入的新节点上面看日志信息: </p>
<figure class="highlight plaintext"><figcaption><span>'Starting group replication recovery with view_id 14829776327826555:2'</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2016-12-29T02:17:56.390895-00:00 13 [Note] &#x27;CHANGE MASTER TO FOR CHANNEL &#x27;group_replication_recovery&#x27; executed&#x27;. Previous state master_host=&#x27;&#x27;, master_port= 3306, master_log_file=&#x27;&#x27;, master_log_pos= 4, master_bind=&#x27;&#x27;. New state master_host=&#x27;b9cc57bc41f3&#x27;, master_port= 3306, master_log_file=&#x27;&#x27;, master_log_pos= 4, master_bind=&#x27;&#x27;.</span><br><span class="line">2016-12-29T02:17:56.699417-00:00 13 [Note] Plugin group_replication reported: &#x27;Establishing connection to a group replication recovery donor 1894ecbf-cd6a-11e6-b76f-0242ac110002 at b9cc57bc41f3 port: 3306.&#x27;</span><br><span class="line">2016-12-29T02:17:56.700203-00:00 14 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &#x27;START SLAVE Syntax&#x27; in the MySQL Manual for more information.</span><br><span class="line">2016-12-29T02:17:56.730434-00:00 15 [Note] Slave SQL thread for channel &#x27;group_replication_recovery&#x27; initialized, starting replication in log &#x27;FIRST&#x27; at position 0, relay log &#x27;/var/lib/mysql/relaylog-group_replication_recovery.000001&#x27; position: 4</span><br><span class="line">2016-12-29T02:18:29.761682-00:00 14 [ERROR] Slave I/O for channel &#x27;group_replication_recovery&#x27;: error connecting to master &#x27;repl@b9cc57bc41f3:3306&#x27; - retry-time: 60  retries: 1, Error_code: 2005</span><br><span class="line">2016-12-29T02:18:29.761741-00:00 14 [Note] Slave I/O thread for channel &#x27;group_replication_recovery&#x27; killed while connecting to master ......</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其中可以看到: 选择donor的时候, 是通过hostname 做change master的, 然而 hostname  b9cc57bc41f3 是不可以解析的. 导致了</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO FOR CHANNEL &#x27;group_replication_recovery&#x27; executed&#x27;. </span><br><span class="line">Previous state master_host=&#x27;b9cc57bc41f3&#x27;, master_port= 3306, master_log_file=&#x27;&#x27;, master_log_pos= 4, master_bind=&#x27;&#x27; .</span><br><span class="line">New state master_host=&#x27;b9cc57bc41f3&#x27;, master_port= 3306, master_log_file=&#x27;&#x27;, master_log_pos= 4, master_bind=&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<p>从而导致了无法正常连接到 donor, 最终导致恢复失败, replication_group_members 信息中 MEMBER_STATE 一直是 RECOVERING状态. </p>
<p><code>There was an error when connecting to the donor server. </code><br><code>Check group replication recovery&#39;s connection credentials.</code> </p>
<p>当recovery恢复尝试一定次数之后, 会退出MGR Cluster: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2016-12-29T02:32:29.568996-00:00 13 [ERROR] Plugin group_replication </span><br><span class="line">reported: &#x27;Fatal error during the Recovery process of Group Replication. The server will leave the group.&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="代码分析-1"><a href="#代码分析-1" class="headerlink" title="代码分析"></a>代码分析</h3><p>代码文件路径: </p>
<pre><code>rapid/plugin/group_replication/src/plugin.cc
</code></pre>
<p>调试到具体代码发现是 在 configure_group_member_manager 函数中声明的hostname, 调用 get_server_parameters函数进行初始化的</p>
<p>具体configure_group_member_manager函数代码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">int configure_group_member_manager()</span><br><span class="line">&#123;</span><br><span class="line">  DBUG_ENTER(&quot;configure_group_member_manager&quot;);</span><br><span class="line"></span><br><span class="line">  /*</span><br><span class="line">    Ensure that group communication interfaces are initialized</span><br><span class="line">    and ready to use, since plugin can leave the group on errors</span><br><span class="line">    but continue to be active.</span><br><span class="line">  */</span><br><span class="line">  std::string gcs_local_member_identifier;</span><br><span class="line">  if (gcs_module-&gt;get_local_member_identifier(gcs_local_member_identifier))</span><br><span class="line">  &#123;</span><br><span class="line">    /* purecov: begin inspected */</span><br><span class="line">    log_message(MY_ERROR_LEVEL, &quot;Error calling group communication interfaces&quot;);</span><br><span class="line">    DBUG_RETURN(GROUP_REPLICATION_COMMUNICATION_LAYER_SESSION_ERROR);</span><br><span class="line">    /* purecov: end */</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //Configure Group Member Manager</span><br><span class="line">  char *hostname, *uuid;</span><br><span class="line">  uint port;</span><br><span class="line">  unsigned int server_version;</span><br><span class="line">  get_server_parameters(&amp;hostname, &amp;port, &amp;uuid, &amp;server_version);</span><br><span class="line">  plugin_version= server_version;</span><br><span class="line"></span><br><span class="line">  uint32 local_version= plugin_version;</span><br><span class="line">  DBUG_EXECUTE_IF(&quot;group_replication_compatibility_higher_patch_version&quot;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    local_version= plugin_version + (0x000001);</span><br><span class="line">                  &#125;;);</span><br><span class="line">  DBUG_EXECUTE_IF(&quot;group_replication_compatibility_higher_minor_version&quot;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    local_version= plugin_version + (0x000100);</span><br><span class="line">                  &#125;;);</span><br><span class="line">  DBUG_EXECUTE_IF(&quot;group_replication_compatibility_higher_major_version&quot;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    local_version= plugin_version + (0x010000);</span><br><span class="line">                  &#125;;);</span><br><span class="line">  Member_version local_member_plugin_version(local_version);</span><br><span class="line">  delete local_member_info;</span><br><span class="line">  local_member_info= new Group_member_info(hostname,</span><br><span class="line">                                           port,</span><br><span class="line">                                           uuid,</span><br><span class="line">                                           write_set_extraction_algorithm,</span><br><span class="line">                                           gcs_local_member_identifier,</span><br><span class="line">                                           Group_member_info::MEMBER_OFFLINE,</span><br><span class="line">                                           local_member_plugin_version,</span><br><span class="line">                                           gtid_assignment_block_size_var,</span><br><span class="line">                                           Group_member_info::MEMBER_ROLE_SECONDARY,</span><br><span class="line">                                           single_primary_mode_var,</span><br><span class="line">                                           enforce_update_everywhere_checks_var);</span><br><span class="line"></span><br><span class="line">  //Create the membership info visible for the group</span><br><span class="line">  delete group_member_mgr;</span><br><span class="line">  group_member_mgr= new Group_member_info_manager(local_member_info);</span><br><span class="line"></span><br><span class="line">  DBUG_RETURN(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于get_server_parameters:</p>
<p>路径:</p>
<pre><code>sql/rpl_group_replication.cc -- row_num 326  行
</code></pre>
<p>代码: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">void get_server_parameters(char **hostname, uint *port, char** uuid,</span><br><span class="line">                           unsigned int *out_server_version)</span><br><span class="line">&#123;</span><br><span class="line">  /*</span><br><span class="line">    use startup option report-host and report-port when provided,</span><br><span class="line">    as value provided by glob_hostname, which used gethostname() function</span><br><span class="line">    internally to determine hostname, will not always provide correct</span><br><span class="line">    network interface, especially in case of multiple network interfaces.</span><br><span class="line">  */</span><br><span class="line">  if (report_host)</span><br><span class="line">    *hostname= report_host;</span><br><span class="line">  else</span><br><span class="line">    *hostname= glob_hostname;</span><br><span class="line"></span><br><span class="line">  if (report_port)</span><br><span class="line">    *port= report_port;</span><br><span class="line">  else</span><br><span class="line">    *port= mysqld_port;</span><br><span class="line"></span><br><span class="line">  *uuid= server_uuid;</span><br><span class="line"></span><br><span class="line">  //Convert server version to hex</span><br><span class="line"></span><br><span class="line">  ulong major= 0, minor= 0, patch= 0;</span><br><span class="line">  char *pos= server_version, *end_pos;</span><br><span class="line">  //extract each server decimal number, e.g., for 5.9.30 -&gt; 5, 9 and 30</span><br><span class="line">  major= strtoul(pos, &amp;end_pos, 10);  pos=end_pos+1;</span><br><span class="line">  minor= strtoul(pos, &amp;end_pos, 10);  pos=end_pos+1;</span><br><span class="line">  patch= strtoul(pos, &amp;end_pos, 10);</span><br><span class="line"></span><br><span class="line">  /*</span><br><span class="line">    Convert to a equivalent hex representation.</span><br><span class="line">    5.9.30 -&gt; 0x050930</span><br><span class="line">    version= 0 x 16^5 + 5 x 16^4 + 0 x 16^3 + 9 x 16^2 + 3 x 16^1 + 0 x 16^0</span><br><span class="line">  */</span><br><span class="line">  int v1= patch / 10;</span><br><span class="line">  int v0= patch - v1 * 10;</span><br><span class="line">  int v3= minor / 10;</span><br><span class="line">  int v2= minor - v3 * 10;</span><br><span class="line">  int v5= major / 10;</span><br><span class="line">  int v4= major - v5 * 10;</span><br><span class="line"></span><br><span class="line">  *out_server_version= v0 + v1 * 16 + v2 * 256 + v3 * 4096 + v4 * 65536 + v5 * 1048576;</span><br><span class="line"></span><br><span class="line">  return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从10-20行可以看出 hostname 是可以通过 report_host来进行配置的.</p>
<h3 id="问题处理-1"><a href="#问题处理-1" class="headerlink" title="问题处理"></a>问题处理</h3><p>问题原因分析出来了,解决办法也就很明显了: </p>
<h4 id="解决办法-1"><a href="#解决办法-1" class="headerlink" title="解决办法 1"></a>解决办法 1</h4><pre><code>每个实例部署的时候,配置好 report_host
</code></pre>
<p>设置完 report_host 之后: </p>
<pre><code>root@(none) 09:24:01&gt;show variables like &#39;%report%&#39;;
+-----------------+------------+
| Variable_name   | Value      |
+-----------------+------------+
| report_host     | 172.17.0.2 |
| report_port     | 3306       | 
+-----------------+------------+
</code></pre>
<p>配置完成之后: (member_host列展示的是 docker的 ip)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@(none) 09:23:59&gt;select * from  performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 764aaaf4-cda6-11e6-84d0-0242ac110002 | 172.17.0.2  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | c8379254-cda6-11e6-8738-0242ac110003 | 172.17.0.3  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | cea19648-cda6-11e6-8817-0242ac110004 | 172.17.0.4  |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="解决办法-2"><a href="#解决办法-2" class="headerlink" title="解决办法 2"></a>解决办法 2</h4><pre><code>把组里的成员列表, ip 和host 的对应关系写入到 /etc/hosts 文件.
</code></pre>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>MGR的配置过程已经算是很简单了,内部自动化程度相对比较高了, 遇到的问题,记录分享一下, 然大家也少走一些弯路. 后续…</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/MySQL/">MySQL</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Docker/">Docker</a><a href="/tags/MySQL/">MySQL</a><a href="/tags/Group-Replicaiton/">Group Replicaiton</a><a href="/tags/MGR/">MGR</a><a href="/tags/Replicaiton/">Replicaiton</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://ruiaylin.github.io/2016/12/28/mgr-02-summary-of-configuring-mysql-group-replication-cluster/" data-title="【 MGR 】02 - Summary of configuring MGR cluster | ruiayLin&#39;s Blog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/01/12/mgr-03-Concurrent-DDLs-cause-inconsistency-on-Multi-Primary/" title="【 MGR 】03 The Problom about Concurrent DDLs [转]">
  <strong>上一篇：</strong><br/>
  <span>
  【 MGR 】03 The Problom about Concurrent DDLs [转]</span>
</a>
</div>


<div class="next">
<a href="/2016/12/22/mgr-01-build-a-mysql-group-replication-cluster-in-10-minutes/"  title="【 MGR 】01 - Build a MGR cluster in ten minutes">
 <strong>下一篇：</strong><br/> 
 <span>【 MGR 】01 - Build a MGR cluster in ten minutes
</span>
</a>
</div>

</nav>

	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98-%E5%BC%BA%E5%88%B6%E4%BD%BF%E7%94%A8root%E5%88%9B%E5%BB%BAmgr%E7%9B%B8%E5%85%B3%E8%B4%A6%E6%88%B7"><span class="toc-number">2.</span> <span class="toc-text">第一个问题: 强制使用root创建mgr相关账户</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E6%8F%8F%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">详细描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">代码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86"><span class="toc-number">2.3.</span> <span class="toc-text">问题处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E4%B8%AA%E9%97%AE%E9%A2%98-MGR%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98host%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="toc-number">3.</span> <span class="toc-text">第二个问题: MGR集群成员host的默认值</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90-1"><span class="toc-number">3.2.</span> <span class="toc-text">代码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86-1"><span class="toc-number">3.3.</span> <span class="toc-text">问题处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">解决办法 1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95-2"><span class="toc-number">3.3.2.</span> <span class="toc-text">解决办法 2</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary"><span class="toc-number">4.</span> <span class="toc-text">Summary</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Go/" title="Go">Go<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/MySQL/" title="MySQL">MySQL<sup>18</sup></a></li>
		  
		
		  
			<li><a href="/categories/NewSQL/" title="NewSQL">NewSQL<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Oracle/" title="Oracle">Oracle<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Python/" title="Python">Python<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/MySQL/" title="MySQL">MySQL<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/OPS/" title="OPS">OPS<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Docker/" title="Docker">Docker<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Fabric/" title="Fabric">Fabric<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Go/" title="Go">Go<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Group-Replicaiton/" title="Group Replicaiton">Group Replicaiton<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/MGR/" title="MGR">MGR<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Replicaiton/" title="Replicaiton">Replicaiton<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/MHA/" title="MHA">MHA<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Xtrabackup/" title="Xtrabackup">Xtrabackup<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/DNS/" title="DNS">DNS<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Sharding/" title="Sharding">Sharding<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Kernel/" title="Kernel">Kernel<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/PowerDNS/" title="PowerDNS">PowerDNS<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Discourse/" title="Discourse">Discourse<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Forum/" title="Forum">Forum<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/转载/" title="转载">转载<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/gh-ost/" title="gh-ost">gh-ost<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/DDL/" title="DDL">DDL<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">知识链接</p>
    <ul>
        
          <li>
            
            	<a href="http://mysql.taobao.org/monthly/" target="_blank" title=" 内核月报">阿里内核月报</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.zhihu.com/org/polardb-x" target="_blank" title="PloarDB-X专栏">PloarDB-X专栏</a>
            
          </li>
        
          <li>
            
            	<a href="https://cn.pingcap.com/blog/" target="_blank" title="TiDB 博客">TiDB 博客</a>
            
          </li>
        
          <li>
            
            	<a href="https://dev.mysql.com/doc/refman/8.0/en/" target="_blank" title="MySQL 8.0 Docs">MySQL 8.0 Docs</a>
            
          </li>
        
          <li>
            
            	<a href="https://dev.mysql.com/blog-archive/" target="_blank" title="MySQL Server Blog">MySQL Server Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://lefred.be/" target="_blank" title="Lefred&#39;s blog">Lefred&#39;s blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.zhihu.com/people/wen-zheng-hu" target="_blank" title="温正湖专栏">温正湖专栏</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.percona.com/blog/" target="_blank" title="Percona Blog">Percona Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://engineering.fb.com/" target="_blank" title="Meta Engineering">Meta Engineering</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.uber.com/en-US/blog/engineering/" target="_blank" title="Uber Engineering">Uber Engineering</a>
            
          </li>
        
          <li>
            
            	<a href="https://github.blog/category/engineering/" target="_blank" title="Github Engineering">Github Engineering</a>
            
          </li>
        
          <li>
            
            	<a href="https://medium.com/pinterest-engineering" target="_blank" title="Pinterest Engineering">Pinterest Engineering</a>
            
          </li>
        
          <li>
            
            	<a href="https://flask.palletsprojects.com/" target="_blank" title="Flask Docs">Flask Docs</a>
            
          </li>
        
          <li>
            
            	<a href="https://tympanus.net/codrops/" target="_blank" title="Codrops front">Codrops front</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 我是瑞超，美团到店DBA负责人、数据库架构师。欢迎交流。 <br/>
			</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2024 
		
		<a href="/about" target="_blank" title="ruichao.lin">ruichao.lin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
